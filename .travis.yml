dist: trusty

sudo: false
language: python

git:
  depth: false

matrix:
  fast_finish: true

cache:
  - pip

matrix:
  include:
    - os: linux
      dist: trusty
      python: 3.6
      sudo: false
      env: PY_TAG='cp36'
    - os: linux
      dist: xenial
      python: 3.7
      sudo: true
      env: PY_TAG='cp37'

install:
  - travis_retry pip install -e .[travis]
  - travis_retry pip install codecov ipython

script:
  - inv license-check

  - echo 'Running tests...' && echo -n 'travis_fold:start:pytest'
  - if [[ $TRAVIS_BRANCH != "master" ]]; then pytest -s -m 'not slow and not extra'; fi # don't run slow/extra tests if not on master branch
  - if [[ $TRAVIS_BRANCH == "master" ]]; then pytest -s --cov=qucumber --no-cov-on-fail; fi
  - echo -n 'travis_fold:end:pytest'

  # lint code files
  - flake8
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then black --diff --check ./; fi

  - inv lint-examples -l flake8
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then inv lint-examples -l black; fi

  - echo 'Building package...' && echo -n 'travis_fold:start:pkg_build'
  - python setup.py sdist
  - echo -n 'travis_fold:end:pkg_build'

after_success:
  - if [[ $TRAVIS_BRANCH == "master" ]]; then codecov; fi

before_deploy:
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then tar -czvf examples.tar.gz examples; fi
  - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then zip -r examples.zip examples; fi
deploy:
  - provider: releases
    skip-cleanup: true
    api-key: "$GITHUB_TOKEN"
    file:
      - dist/*.tar.gz
    file_glob: true
    on:
      repo: PIQuIL/QuCumber
      tags: true
  - provider: releases  # only upload examples folder once per deploy
    skip-cleanup: true
    api-key: "$GITHUB_TOKEN"
    file:
      - examples.tar.gz
      - examples.zip
    file_glob: true
    on:
      repo: PIQuIL/QuCumber
      tags: true
      condition: $TRAVIS_PYTHON_VERSION == '3.6'
  - provider: pypi
    skip_existing: true
    distributions: "sdist bdist_wheel --python-tag=$PY_TAG"
    user: PIQuIL
    password:
      secure: ANzomjrVPkzLO7MG9Zekl1Tz/GiO6rJyqZSWlWxF5a8M0+ZBJsFb7Do6kxPNulkEFwEnvjnJpzpY2ryWlhrXnzGZitzWIa5IDLRRHmSQ3GRNPHMIRqf1xle+8/0IwDBuC/eTsOkit7WU1j9lgurCj8snXuTLUVEqf/SecAcLpmLrelRFvz//ZcOopIbwD66RJWT8pYGBH/L3MMIDFj1bIf0UIpXdBXgeTJhxW054+BhdFPGI66IvWU/kOlOcE606wqRqI9bdvop34OewJFnOQ9Elii7LKUPNXoWmq1PrvXCIc1c50BGcLoWFM2CDiOiirzhvvUymtT/Na2BUqPpmnkbi+iRMyaIa6FOa8UIP4TCGuFd4JJlYxaq84bAmikI+1LOOGhfJ0+LACaJaqEM3WRL8VfP/xjWF9GzOuE5W8/fQQUntZaHkqQi4VV2wzULSkc5CpbrR2iX71dROWO4ETzz1wGXmO0dTVfCWMbqk7dT8OPft+tHsWWJqqeCEL3wj1uYEIYpCwLo9oSyVXwrhzRW0dysZfTCx/XfDaws3eFA6iMg6dUoBt12kwGZ5vCbgjBwPOmQrRMUEmYoyZz8n20HKojoxzUpwueFN/nbLv76arJbN8bLeb/GyE6r1Rw0DEzs8f0fBtv5agUnIpMh6EPOFYN4rwHMxt52HU7BB/Kg=
    on:
      repo: PIQuIL/QuCumber
      tags: true

notifications:
  slack:
    secure: U7+T5dRZ8dit/ZwQKSNUOV3BsAUx5I/ML6ukwqqQZ8RmJdZn2gSAFal2U72LZlQysR8EHUybQJwvpfG2BYaoSYdxkmZtMDuzxCefz+L+F+GKaJOQchfTkSdo93LO4MVlxilLs3srp0NsH0dch9qUzSqVE+T0YO6mj9N+uAqngq5wuZIpbB6jo56X8RoLNQXHxeqgxaWWWaCpIta3g0vzVDIYbLtLHOW3XuvpmJEengb1QdlJPz+9ooJnYNhinP1XKuPxSuzzU/czME+L2oJJMGS6iCIAii8j1fU6iRdsasBTqH23lBr/Pe3Wcxb6+bdfYoX5V2IzFt64UZGQu84AibuK3SaYc5INri6iGQV0YS1pGzoE4QNceoMzneF2WqA0Nsxzdlj6Pcjy86Ddjskdn5a+yGc9mbr2rj72KeTD3DoVobMJB6yJDHRwHOXKep8btgqOja5+XD38Y1Xpsm9cL7IYx9Efz+9oHyaNram1QhW9Gj1oEktREtEbQwZKztVXGJnFBWXkvtM7e8VuUMVWb2siFhdmC9qG/ToEWLPZeVs+/qOTjAnWm52ao4071ncbL/uaZkkXT/3lktpEQBWsAbtq9gn5dIdbS6iFFRBiNULDBy3YxBGcSnTW03RUoqC5jrnp9x1Saq48ovCCy0FIMqBQPEVuynRFbNqInbHJqVQ=
